<body>
	<table>
		<tr>
			<td rowspan="3"><canvas id="target"></canvas></td>
			<td><input id="trbFreqMax" type="range" value=100 min=1 max=200 style="width:200px;" onmousemove="onScroll();"/></td>
			<td><span id="lblFreqMax"></span></td>
		</tr>
		<tr>
			<td><input id="trbAcc" type="range" value=50 min=0 max=100 style="width:200px;" onmousemove="onScroll();"/></td>
			<td><span id="lblAcc"></span></td>
		</tr>
		<tr>
			<td><input id="trbDeacc" type="range" value=10 min=0 max=100 style="width:200px;" onmousemove="onScroll();"/></td>
			<td><span id="lblDeacc"></span></td>
		</tr>
	</table>
</body>

<script type="text/javascript" src="script/drawer.js"></script>
<script type="text/javascript" src="script/math.js"></script>
<script type="text/javascript" src="script/motor.js"></script>
<script type="text/javascript">
const ROTOR_DIAMETER = 300;
const STATOR_DIAMETER = 320;
const ROTOR_POLE = 8;
const STATOR_POLE = 4;
const STATOR_GAP = 0.2;
const MAGNET_GAP = 0.2;
const MAGNET_THICKNESS = 5;

let drawer = new Drawer("target", STATOR_DIAMETER+20, STATOR_DIAMETER+20);
let motor = new Motor();
let freqMax = 0.0;
let freqMin = 0.0;
let acc = 0.0;
let deacc = 0.0;

motor.pos = new vec3(STATOR_DIAMETER/2+10, STATOR_DIAMETER/2+10, 0);
motor.createStator(STATOR_DIAMETER, ROTOR_DIAMETER+4, STATOR_POLE, STATOR_GAP);
motor.createRotor(ROTOR_DIAMETER, MAGNET_THICKNESS, ROTOR_POLE, MAGNET_GAP);

onScroll();
requestNextAnimationFrame(main);

function onScroll() {
	freqMax = document.getElementById("trbFreqMax").value;
	acc = 0.1*Math.pow(2.0, document.getElementById("trbAcc").value / 100)-0.1;
	deacc = 0.1-0.1*Math.pow(2.0, document.getElementById("trbDeacc").value / 100);
	acc = parseInt(acc*1000)/1000;
	deacc = parseInt(deacc*1000)/1000;
	document.getElementById("lblFreqMax").innerHTML = freqMax + "rpm";
	document.getElementById("lblAcc").innerHTML = acc;
	document.getElementById("lblDeacc").innerHTML = deacc;

	if(1.0<motor.delta_omega) {
		motor.delta_omega = acc;
	} else {
		motor.delta_omega = deacc;
	}
}

function main() {
	drawer.clear();

	motor.draw(drawer);

	if (freqMax/60 < motor.omega) {
		motor.delta_omega = deacc;
	}
	if (motor.omega < freqMin/60) {
		motor.delta_omega = acc;
	}
	motor.step();

	requestNextAnimationFrame(main);
}
</script>
